# Vulnerability Discovery & Reporting

This diagram illustrates the complete vulnerability discovery workflow from initial scanning through validation and reporting.

## Overview

Vulnerability discovery involves:
1. Root agent spawning specialized discovery agents
2. Discovery agents testing for specific vulnerability classes
3. Validation agents creating proof-of-concept exploits
4. Reporting agents documenting findings
5. Real-time vulnerability display to user

## Sequence Diagram

```mermaid
sequenceDiagram
    autonumber
    participant Root as Root Agent
    participant Discovery as Discovery Agent
    participant LLM
    participant Tools as Security Tools
    participant Proxy as HTTP Proxy
    participant Validation as Validation Agent
    participant Reporter as create_vulnerability_report()
    participant Tracer
    participant CLI as CLI Display

    rect rgb(240, 248, 255)
        Note over Root,Discovery: Phase 1: Discovery Agent Creation
        Root->>Root: Analyze target for testing needs

        Root->>Discovery: create_agent(<br/>task="Find SQL injection vulnerabilities",<br/>name="sqli_discovery",<br/>prompt_modules="sql_injection"<br/>)

        activate Discovery
        Discovery->>Discovery: Load sql_injection module
        Note right of Discovery: Module provides:<br/>- Injection patterns<br/>- Detection methods<br/>- Payload databases<br/>- False positive guidance
    end

    rect rgb(255, 248, 240)
        Note over Discovery,Proxy: Phase 2: Automated Discovery
        Discovery->>LLM: Generate testing strategy

        loop Discovery iterations
            Discovery->>Tools: terminal_execute("sqlmap -u {url}")
            Tools-->>Discovery: Scan results

            Discovery->>Tools: browser_action(goto, click, type)
            Tools-->>Discovery: Page responses

            Discovery->>Proxy: list_requests(filter="status:500")
            Proxy-->>Discovery: Error responses

            Discovery->>Proxy: view_request(id)
            Proxy-->>Discovery: Full request/response

            Discovery->>Discovery: Analyze for injection indicators
            Note right of Discovery: Indicators:<br/>- Error messages<br/>- Response time anomalies<br/>- Content differences
        end

        Discovery->>Discovery: Compile potential findings
        Discovery-->>Root: send_message_to_agent(<br/>"Found 3 potential SQLi points"<br/>)
    end

    rect rgb(240, 255, 240)
        Note over Root,Validation: Phase 3: Validation Agent Creation
        Root->>Root: Receive discovery results

        Root->>Validation: create_agent(<br/>task="Validate SQLi at /api/users?id=1",<br/>name="sqli_validation",<br/>prompt_modules="sql_injection"<br/>)

        activate Validation
        Validation->>Validation: Load same module for PoC creation
    end

    rect rgb(255, 240, 255)
        Note over Validation,Tools: Phase 4: Proof-of-Concept Creation
        loop Validation iterations
            Validation->>LLM: Plan exploitation strategy

            Validation->>Tools: python_action("""<br/>import requests<br/>payload = "1' UNION SELECT..."<br/>r = requests.get(url, params={'id': payload})<br/>print(r.text)<br/>""")
            Tools-->>Validation: Response with extracted data

            Validation->>Proxy: send_request(method, url, body)
            Proxy-->>Validation: Direct HTTP response

            Validation->>Validation: Verify data extraction
            Note right of Validation: PoC requirements:<br/>- Concrete impact<br/>- Reproducible steps<br/>- Data exfiltration proof
        end

        alt Vulnerability confirmed
            Validation-->>Root: send_message_to_agent(<br/>"Confirmed: SQLi extracts user data"<br/>)
        else False positive
            Validation-->>Root: send_message_to_agent(<br/>"False positive: Error was benign"<br/>)
        end
        deactivate Validation
    end

    rect rgb(255, 255, 240)
        Note over Root,CLI: Phase 5: Vulnerability Reporting
        Root->>Reporter: create_vulnerability_report(<br/>title="SQL Injection in User API",<br/>severity="critical",<br/>content="..."<br/>)

        Reporter->>Tracer: add_vulnerability_report(report)
        Tracer->>Tracer: Store in telemetry
        Tracer->>Tracer: Trigger callback

        Tracer->>CLI: vulnerability_callback(report)
        CLI->>CLI: Display vulnerability panel
        Note right of CLI: Real-time display:<br/>┌─ Critical: SQL Injection ─┐<br/>│ Endpoint: /api/users      │<br/>│ Impact: Data extraction   │<br/>└───────────────────────────┘
    end

    Discovery-->>Root: agent_finish("Discovery complete")
    deactivate Discovery

    Root->>Root: Continue with next vulnerability class
```

## Multi-Vulnerability Parallel Discovery

```mermaid
sequenceDiagram
    autonumber
    participant Root as Root Agent
    participant SQLi as SQLi Discovery
    participant XSS as XSS Discovery
    participant IDOR as IDOR Discovery
    participant Auth as Auth Discovery

    Root->>Root: Analyze target attack surface

    par Parallel vulnerability scanning
        Root->>SQLi: create_agent(modules="sql_injection")
        activate SQLi
    and
        Root->>XSS: create_agent(modules="xss")
        activate XSS
    and
        Root->>IDOR: create_agent(modules="idor")
        activate IDOR
    and
        Root->>Auth: create_agent(modules="authentication_jwt")
        activate Auth
    end

    Note over SQLi,Auth: All agents execute in parallel threads

    SQLi-->>Root: Found 2 SQLi vulnerabilities
    deactivate SQLi

    XSS-->>Root: Found 1 stored XSS
    deactivate XSS

    IDOR-->>Root: Found 3 IDOR issues
    deactivate IDOR

    Auth-->>Root: JWT algorithm confusion possible
    deactivate Auth

    Root->>Root: Aggregate all findings
    Root->>Root: Create validation agents for confirmed findings
```

## Vulnerability Module Integration

```mermaid
sequenceDiagram
    autonumber
    participant Agent
    participant LLM
    participant Module as Prompt Module
    participant SystemPrompt as System Prompt Builder

    Agent->>Agent: Initialize with prompt_modules="sql_injection,idor"

    Agent->>Module: Load sql_injection.jinja
    Module-->>Agent: SQL injection knowledge

    Agent->>Module: Load idor.jinja
    Module-->>Agent: IDOR knowledge

    Agent->>SystemPrompt: Build system prompt
    SystemPrompt->>SystemPrompt: Add base system prompt
    SystemPrompt->>SystemPrompt: Add tool definitions
    SystemPrompt->>SystemPrompt: Inject vulnerability modules
    Note right of SystemPrompt: <vulnerability_guide><br/>  <title>SQL Injection</title><br/>  <methodology>...</methodology><br/>  <payloads>...</payloads><br/></vulnerability_guide>

    SystemPrompt-->>Agent: Complete system prompt

    Agent->>LLM: generate(messages=[system_prompt, task])
    Note right of LLM: LLM has specialized<br/>knowledge for testing
```

## Key Components

| Component | File Location | Responsibility |
|-----------|---------------|----------------|
| Discovery Agent | `agents/StrixAgent/` | Specialized vulnerability scanning |
| Validation Agent | `agents/StrixAgent/` | PoC creation and verification |
| Vulnerability Modules | `prompts/vulnerabilities/` | Specialized testing knowledge |
| create_vulnerability_report | `tools/reporting/actions.py` | Report generation |
| Tracer | `telemetry/tracer.py` | Report storage and callbacks |
| CLI Renderer | `interface/tool_components/reporting_renderer.py` | Real-time display |

## Vulnerability Severity Levels

| Severity | Criteria | Examples |
|----------|----------|----------|
| **Critical** | Remote code execution, full data breach | SQLi with data extraction, RCE |
| **High** | Significant data exposure, privilege escalation | Stored XSS, IDOR on sensitive data |
| **Medium** | Limited data exposure, requires user interaction | Reflected XSS, CSRF |
| **Low** | Minor information disclosure | Verbose errors, version disclosure |
| **Info** | Observations, recommendations | Missing headers, outdated libraries |

## Vulnerability Report Structure

```python
VulnerabilityReport:
    title: str              # "SQL Injection in User API"
    severity: str           # "critical" | "high" | "medium" | "low" | "info"
    content: str            # Detailed description with PoC
    metadata:
        endpoint: str       # Affected endpoint
        method: str         # HTTP method
        parameter: str      # Vulnerable parameter
        payload: str        # Working payload
        impact: str         # Business impact description
        reproduction: str   # Steps to reproduce
        remediation: str    # Fix recommendations
```

## False Positive Prevention

```mermaid
sequenceDiagram
    autonumber
    participant Discovery
    participant Validation
    participant Root

    Discovery->>Discovery: Detect potential vulnerability
    Note right of Discovery: Initial indicator found

    Discovery->>Validation: Request validation

    Validation->>Validation: Attempt exploitation
    Validation->>Validation: Verify concrete impact

    alt Concrete proof obtained
        Validation->>Validation: Document reproduction steps
        Validation->>Validation: Capture evidence
        Validation-->>Root: CONFIRMED vulnerability
    else Cannot reproduce
        Validation->>Validation: Try alternative approaches
        alt Still fails
            Validation-->>Root: FALSE POSITIVE
            Note right of Root: Not reported
        end
    else Partial success
        Validation-->>Root: NEEDS MANUAL REVIEW
        Note right of Root: Reported with caveat
    end
```
